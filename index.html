<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X-Pet Strategist Simulator</title>
    <link rel="stylesheet" href="assets/tailwind.css">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='12' fill='%23111827'/%3E%3Cpath d='M18 38c4 6 10 9 14 9s10-3 14-9M24 22c0 5 4 10 8 10s8-5 8-10' stroke='%2360a5fa' stroke-width='4' stroke-linecap='round' stroke-linejoin='round' fill='none'/%3E%3Ccircle cx='24' cy='24' r='3' fill='%23facc15'/%3E%3Ccircle cx='40' cy='24' r='3' fill='%23facc15'/%3E%3C/svg%3E">
    <!-- Inter Font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; }

        /* Custom Styles for Sleek/High-Contrast Dark Mode */
        .app-card {
            background-color: #0d0d1a; /* Very deep dark color */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            border: 1px solid #1f2937; /* Subtle dark border */
        }

        .status-block {
            background-color: #1a1a2e; /* Primary component color */
            border-radius: 16px;
            padding: 1.25rem;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.2); /* Soft inner shadow for depth */
        }
        
        /* Modern Pill Buttons */
        .action-btn {
            border-radius: 0.75rem;
            font-weight: 700;
            padding: 0.75rem 1rem;
            color: #ffffff;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.35);
        }

        .action-btn:hover {
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.45);
        }

        .action-btn:active {
            transform: scale(0.98);
        }

        .action-btn:disabled {
            opacity: 0.3;
            box-shadow: none;
            cursor: not-allowed;
        }

        /* Stat Pill styling: Higher contrast */
        .stat-pill {
            background-color: #1f2937; /* Darker stat background */
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            border-radius: 0.75rem;
            gap: 0.75rem;
            border: 1px solid #374151;
        }

        /* HP Bar track for better depth */
        #hp-bar-track {
            background-color: #111827;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.6);
        }

        /* High-contrast status line for AP/SP */
        .currency-display {
            background-color: #111827;
            display: flex;
            justify-content: space-between;
            font-size: 1.25rem;
            font-weight: 800;
            padding: 1rem;
            border-radius: 0.75rem;
            margin-top: 1rem;
            border: 1px solid #374151;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen p-4 flex items-center justify-center">

    <div id="app" class="w-full max-w-3xl app-card rounded-3xl p-6 md:p-8">
        <header class="text-center mb-6">
            <h1 class="text-4xl font-extrabold text-blue-300 tracking-wider">X-Pet: Strategist</h1>
            <p class="text-sm text-gray-400 mt-2">Built for seamless PC + mobile play. Manage your Pal anywhere.</p>
            <p id="user-id-display" class="text-xs text-gray-600 mt-1"></p>
        </header>

        <!-- Pet Status Section -->
        <div id="pet-status" class="status-block mb-6">
            <div class="flex items-center justify-between mb-4">
                <span id="pet-emoji" class="text-7xl">ü•ö</span>
                <div class="text-right">
                    <h2 id="pet-name" class="text-3xl font-bold text-gray-50">New Hatchling</h2>
                    <p id="pet-species" class="text-lg font-semibold text-blue-400">Egg</p>
                </div>
            </div>

            <!-- Health Bar -->
            <div class="mb-3">
                <p class="text-sm font-semibold flex justify-between mb-2">
                    <span>Health: <span id="pet-hp-value">100</span>/<span id="pet-max-hp">100</span></span>
                    <span id="decay-status" class="text-xs font-normal text-red-400"></span>
                </p>
                <div id="hp-bar-track" class="w-full rounded-full h-4 overflow-hidden">
                    <div id="hp-bar" class="bg-red-500 h-full rounded-full transition-all duration-500" style="width: 100%;"></div>
                </div>
            </div>

            <!-- AP/SP -->
            <div class="currency-display">
                <span class="text-yellow-400">‚ö° AP: <span id="pet-ap">0</span></span>
                <span class="text-cyan-400">‚ú® SP: <span id="pet-sp">0</span></span>
            </div>
        </div>

        <!-- Injury Status -->
        <div id="injury-status" class="hidden status-block bg-red-800/30 border border-red-500/50 mb-6">
            <p class="font-bold text-red-200 mb-2">üö® INJURED! üö®</p>
            <p class="text-sm text-red-300">2x Health Decay. Disabled from Battles/Training.</p>
            <button onclick="handleHeal()" id="heal-button" class="mt-3 w-full action-btn bg-red-700 hover:bg-red-600 shadow-red-900/50">
                Heal Pet (200 AP)
            </button>
        </div>

        <!-- Stats and Allocation -->
        <div class="mb-6">
            <h3 class="text-xl font-bold mb-3 text-blue-300">Stats (Allocate SP)</h3>
            <div class="space-y-3">
                <div data-stat="str" class="stat-pill">
                    <span class="text-lg">üí™ Strength: <span id="stat-str" class="font-extrabold text-white">1</span></span>
                    <button onclick="allocateSP('str')" class="bg-blue-600 hover:bg-blue-700 text-white text-lg w-8 h-8 rounded-full transition duration-200">+</button>
                </div>
                <div data-stat="int" class="stat-pill">
                    <span class="text-lg">üß† Intelligence: <span id="stat-int" class="font-extrabold text-white">1</span></span>
                    <button onclick="allocateSP('int')" class="bg-blue-600 hover:bg-blue-700 text-white text-lg w-8 h-8 rounded-full transition duration-200">+</button>
                </div>
                <div data-stat="end" class="stat-pill">
                    <span class="text-lg">üõ°Ô∏è Endurance: <span id="stat-end" class="font-extrabold text-white">1</span></span>
                    <button onclick="allocateSP('end')" class="bg-blue-600 hover:bg-blue-700 text-white text-lg w-8 h-8 rounded-full transition duration-200">+</button>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <button onclick="handleSyncActivity()" id="sync-button" class="action-btn bg-blue-600 hover:bg-blue-500 w-full">
                Sync X Activity <span class="text-sm font-normal">(+AP)</span>
            </button>
            <button onclick="handleFeed()" id="feed-button" class="action-btn bg-green-600 hover:bg-green-500 w-full">
                Feed (100 AP) <span class="text-sm font-normal">(+HP / Pause)</span>
            </button>
            <button onclick="handleTrain()" id="train-button" class="action-btn bg-yellow-600 hover:bg-yellow-500 w-full">
                Train (150 AP) <span class="text-sm font-normal">(+SP / Risk)</span>
            </button>
            <button onclick="handleBattle()" id="battle-button" class="action-btn bg-red-600 hover:bg-red-500 w-full">
                Battle (120 AP) <span class="text-sm font-normal">(Massive Gain / High Risk)</span>
            </button>
        </div>

        <!-- X Activity Mixer -->
        <div class="mt-6 status-block border border-blue-900/40">
            <div class="flex items-center justify-between mb-4 flex-wrap gap-2">
                <div>
                    <h3 class="text-xl font-bold text-blue-300">Engagement Sync</h3>
                    <p class="text-sm text-gray-400">Enter likes, comments, reposts, quote posts, and impressions from X. Works on desktop or mobile.</p>
                </div>
                <div class="text-right text-sm text-gray-400">
                    <p>AP Preview: <span id="ap-preview" class="text-blue-300 font-extrabold">50</span></p>
                    <p class="text-xs text-gray-500">(Includes Intelligence bonus)</p>
                </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                <label class="block text-sm text-gray-300">Likes
                    <input id="likes-input" type="number" min="0" step="1" value="0" oninput="updateAPPreview()" class="mt-1 w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white focus:ring-blue-500 focus:border-blue-500">
                </label>
                <label class="block text-sm text-gray-300">Comments
                    <input id="comments-input" type="number" min="0" step="1" value="0" oninput="updateAPPreview()" class="mt-1 w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white focus:ring-blue-500 focus:border-blue-500">
                </label>
                <label class="block text-sm text-gray-300">Reposts
                    <input id="reposts-input" type="number" min="0" step="1" value="0" oninput="updateAPPreview()" class="mt-1 w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white focus:ring-blue-500 focus:border-blue-500">
                </label>
                <label class="block text-sm text-gray-300">Quote Posts
                    <input id="quotes-input" type="number" min="0" step="1" value="0" oninput="updateAPPreview()" class="mt-1 w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white focus:ring-blue-500 focus:border-blue-500">
                </label>
                <label class="block text-sm text-gray-300">Impressions
                    <input id="impressions-input" type="number" min="0" step="50" value="0" oninput="updateAPPreview()" class="mt-1 w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white focus:ring-blue-500 focus:border-blue-500">
                </label>
            </div>

            <div class="mt-4 text-sm text-gray-400 space-y-1">
                <p>Weighted gains: Likes (x8), Comments (x12), Reposts (x18), Quote Posts (x22), Impressions (x5 per 250).</p>
                <p>Boosted by Intelligence. Minimum 50 AP per sync to keep cadence smooth on the go.</p>
                <p id="last-sync-details" class="text-gray-300"></p>
            </div>
        </div>

        <!-- Message Log (Sleek console) -->
        <div id="message-log" class="mt-8 h-28 overflow-y-auto p-4 bg-gray-900/50 rounded-xl text-sm text-gray-400 space-y-1 border border-gray-700">
            <p>Welcome, Strategist. Initializing simulation...</p>
        </div>

        <!-- Initialization / Loading -->
        <div id="loading" class="fixed inset-0 bg-gray-900 bg-opacity-95 flex flex-col items-center justify-center z-50">
            <div class="animate-spin rounded-full h-12 w-12 border-4 border-t-blue-400 border-b-blue-700 mb-4"></div>
            <p class="text-lg font-semibold text-blue-400">Authenticating and Syncing Pet Data...</p>
        </div>
        
        <!-- Custom Modal for Pet Name (Now Connect X) -->
        <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-50">
            <div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-80 border border-blue-500/20">
                <h3 class="text-2xl font-bold mb-4 text-blue-400">Sync Your X Profile</h3>
                <p class="text-sm text-gray-400 mb-3">Your pet's survival depends on your X activity!</p>
                <input type="text" id="pet-name-input" placeholder="Enter your @X_handle" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-white mb-4 focus:ring-blue-500 focus:border-blue-500">
                <button onclick="connectXAccountAndHatch()" class="w-full action-btn bg-blue-600 hover:bg-blue-700">
                    Connect & Hatch Pet
                </button>
            </div>
        </div>

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase variables provided by Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId = null;
        let petState = null;
        let logIndex = 0; // For logging
        const AP_MINIMUM = 50;

        // --- Core Pet Data & Rules ---
        const INITIAL_PET_STATE = {
            name: 'Hatchling',
            species: 'Egg',
            emoji: 'ü•ö',
            hp: 100,
            maxHp: 100,
            ap: 0, // Activity Points (Currency)
            sp: 0, // Stat Points (Allocation)
            stats: { str: 1, int: 1, end: 1 },
            isInjured: false,
            lastActivityTimestamp: Date.now(), // Last time *any* action was performed
            decayPauseUntil: Date.now(),      // NEW: Time when the decay pause ends (updated ONLY by Feed)
            lastDecayTimestamp: Date.now(),   // Last time decay was calculated and applied
            evolved: false,
            lastSyncBreakdown: {
                likes: 0,
                comments: 0,
                reposts: 0,
                quotes: 0,
                impressions: 0,
                apGained: 0
            }
        };

        const DECAY_HOURS = 24;
        const FEED_PAUSE_HOURS = 6;
        const DECAY_LOSS_BASE = 15;
        const INJURY_CHANCE = 0.15; // 15%

        // --- Utility Functions ---

        /** Logs a message to the in-app message log. */
        const logMessage = (text, type = 'info') => {
            const logElement = document.getElementById('message-log');
            const p = document.createElement('p');
            logIndex++;
            let color = 'text-gray-400';
            if (type === 'success') color = 'text-green-300';
            if (type === 'warning') color = 'text-yellow-300';
            if (type === 'error') color = 'text-red-300';

            p.className = `${color} text-sm`;
            p.innerHTML = `<span class="text-gray-600 mr-1">${logIndex}.</span> ${text}`;

            if (logElement.firstChild) {
                logElement.insertBefore(p, logElement.firstChild);
            } else {
                logElement.appendChild(p);
            }
            // Keep the log scrolled to the top
            logElement.scrollTop = 0;
        };

        /** Retrieves the Firestore document reference for the pet's data. */
        const getPetDocRef = () => {
            if (!db || !userId) {
                logMessage("Firestore not initialized.", 'error');
                return null;
            }
            // Private user data path: /artifacts/{appId}/users/{userId}/pet_game/pet_data
            return doc(db, `artifacts/${appId}/users/${userId}/pet_game/pet_data`);
        };

        /** Updates the pet state in Firestore. */
        const savePetState = async (updates = {}) => {
            if (!petState) return;

            // Apply local updates first
            Object.assign(petState, updates);

            // Ensure HP doesn't exceed Max HP
            petState.hp = Math.min(petState.hp, petState.maxHp);
            petState.hp = Math.max(0, petState.hp); // HP cannot be negative

            const petRef = getPetDocRef();
            if (petRef) {
                try {
                    await setDoc(petRef, petState, { merge: true });
                } catch (e) {
                    console.error("Error saving pet state: ", e);
                    logMessage("Failed to save state to database.", 'error');
                }
            }
        };

        /** Renders the current pet state to the UI. */
        const renderUI = () => {
            if (!petState) return;

            document.getElementById('pet-name').textContent = petState.name;
            document.getElementById('pet-species').textContent = petState.species;
            document.getElementById('pet-emoji').textContent = petState.emoji;
            document.getElementById('pet-ap').textContent = petState.ap.toLocaleString();
            document.getElementById('pet-sp').textContent = petState.sp;

            // HP Bar
            const hpValue = petState.hp;
            const maxHp = petState.maxHp;
            const hpPercent = maxHp > 0 ? (hpValue / maxHp) * 100 : 0;
            document.getElementById('pet-hp-value').textContent = hpValue;
            document.getElementById('pet-max-hp').textContent = maxHp;
            document.getElementById('hp-bar').style.width = `${hpPercent}%`;
            
            // Dynamic HP Bar Color for better visual feedback
            const hpBar = document.getElementById('hp-bar');
            hpBar.classList.remove('bg-red-500', 'bg-orange-500', 'bg-yellow-500', 'bg-green-500', 'bg-red-900');
            if (hpPercent > 50) {
                hpBar.classList.add('bg-green-500');
            } else if (hpPercent > 20) {
                hpBar.classList.add('bg-yellow-500');
            } else if (hpPercent > 0) {
                hpBar.classList.add('bg-red-500');
            } else {
                hpBar.classList.add('bg-red-900'); // Faded red for death
            }

            // Stats
            document.getElementById('stat-str').textContent = petState.stats.str;
            document.getElementById('stat-int').textContent = petState.stats.int;
            document.getElementById('stat-end').textContent = petState.stats.end;

            // Last sync breakdown
            const lastSyncDetails = document.getElementById('last-sync-details');
            const breakdown = petState.lastSyncBreakdown;
            if (breakdown) {
                lastSyncDetails.textContent = `Last sync ‚Üí +${breakdown.apGained || 0} AP from ${breakdown.likes || 0} likes, ${breakdown.comments || 0} comments, ${breakdown.reposts || 0} reposts, ${breakdown.quotes || 0} quotes, ${breakdown.impressions || 0} impressions.`;
            } else {
                lastSyncDetails.textContent = 'Sync your first X session to see the breakdown here.';
            }

            // Injury Status
            const injuryStatus = document.getElementById('injury-status');
            const decayStatus = document.getElementById('decay-status');
            const actionButtons = document.querySelectorAll('.action-btn');

            if (petState.isInjured) {
                injuryStatus.classList.remove('hidden');
                decayStatus.textContent = '(2x Decay Rate)';
                // Disable high-stakes actions when injured
                document.getElementById('train-button').disabled = true;
                document.getElementById('battle-button').disabled = true;
            } else {
                injuryStatus.classList.add('hidden');
                decayStatus.textContent = '';
                document.getElementById('train-button').disabled = false;
                document.getElementById('battle-button').disabled = false;
            }

            // Button visibility based on AP
            document.getElementById('feed-button').disabled = petState.ap < 100;
            document.getElementById('train-button').disabled = petState.ap < 150 || petState.isInjured;
            document.getElementById('battle-button').disabled = petState.ap < 120 || petState.isInjured;
            document.getElementById('heal-button').disabled = petState.ap < 200;

            // Stat allocation buttons
            const allocateButtons = document.querySelectorAll('.bg-blue-600');
            allocateButtons.forEach(btn => btn.disabled = petState.sp < 1);
            
            // Decay Status Display Logic (shows time remaining until next decay or pause end)
            const currentTime = Date.now();
            const decayTimeMs = DECAY_HOURS * 60 * 60 * 1000;
            
            // 1. Check if Decay is currently paused by a recent Feed action
            if (currentTime < petState.decayPauseUntil) {
                const timeUntilPauseEnds = petState.decayPauseUntil - currentTime;
                const h = Math.floor(timeUntilPauseEnds / (1000 * 60 * 60));
                const m = Math.floor((timeUntilPauseEnds % (1000 * 60 * 60)) / (1000 * 60));
                decayStatus.textContent = `(Decay paused for ${h}h ${m}m)`;
            } else {
                // 2. Pause ended, show time until the next 24-hour cycle is due
                const timeElapsedSinceLastDecay = currentTime - petState.lastDecayTimestamp;
                const nextDecayInMs = decayTimeMs - (timeElapsedSinceLastDecay % decayTimeMs);

                const h = Math.floor(nextDecayInMs / (1000 * 60 * 60));
                const m = Math.floor((nextDecayInMs % (1000 * 60 * 60)) / (1000 * 60));
                decayStatus.textContent = `(Next decay in ${h}h ${m}m)`;
            }

            // Check if pet is dead
            if (petState.hp <= 0) {
                logMessage(`[GAME OVER] ${petState.name} ran out of HP and is gone. Data will be reset on next action.`, 'error');
                actionButtons.forEach(btn => btn.disabled = true);
            }

            updateAPPreview();
        };

        /**
         * Calculates AP gained from X engagement metrics and Intelligence bonus.
         * Ensures a minimum base AP so users on mobile/desktop get predictable value.
         */
        const calculateAPFromMetrics = (metrics) => {
            const likesAP = metrics.likes * 8;
            const commentsAP = metrics.comments * 12;
            const repostsAP = metrics.reposts * 18;
            const quotesAP = metrics.quotes * 22;
            const impressionAP = Math.floor(metrics.impressions / 250) * 5;
            const engagementAP = likesAP + commentsAP + repostsAP + quotesAP + impressionAP;

            const intBonus = petState ? petState.stats.int * 5 : 0;
            const total = engagementAP + intBonus;
            return Math.max(AP_MINIMUM + intBonus, total);
        };

        const readMetricsFromInputs = () => ({
            likes: Math.max(0, Number(document.getElementById('likes-input').value) || 0),
            comments: Math.max(0, Number(document.getElementById('comments-input').value) || 0),
            reposts: Math.max(0, Number(document.getElementById('reposts-input').value) || 0),
            quotes: Math.max(0, Number(document.getElementById('quotes-input').value) || 0),
            impressions: Math.max(0, Number(document.getElementById('impressions-input').value) || 0),
        });

        window.updateAPPreview = () => {
            if (!petState) return;
            const metrics = readMetricsFromInputs();
            const preview = calculateAPFromMetrics(metrics);
            document.getElementById('ap-preview').textContent = preview.toLocaleString();
        };

        /** Checks for and applies health decay based on timestamps. */
        const checkAndApplyDecay = async () => {
            const currentTime = Date.now();
            const decayTimeMs = DECAY_HOURS * 60 * 60 * 1000;
            
            let lastCheckTime = petState.lastDecayTimestamp;
            let decayEvents = 0;
            
            // If the decay is still paused, or if the pet hasn't passed the pause time yet,
            // the check for elapsed 24-hour cycles must start from the moment the pause ends.
            let checkStartTime = Math.max(lastCheckTime, petState.decayPauseUntil);

            // Calculate how many 24-hour cycles have fully elapsed since the effective check start time
            const timeSinceCheckStart = currentTime - checkStartTime;
            if (timeSinceCheckStart > 0) {
                decayEvents = Math.floor(timeSinceCheckStart / decayTimeMs);
            }

            if (decayEvents > 0) {
                // Calculate loss reduced by Endurance (1 End = 5% reduction, max 80% at End 16)
                const endStat = petState.stats.end;
                const reductionPercent = Math.min(0.05 * endStat, 0.8);
                const lossPerCycle = Math.round(DECAY_LOSS_BASE * (1 - reductionPercent));

                // Total Loss
                let totalLoss = lossPerCycle * decayEvents;
                if (petState.isInjured) {
                    totalLoss *= 2; // 2x decay rate when injured
                }
                
                const newHP = petState.hp - totalLoss;

                // Calculate the exact timestamp when the last applied decay cycle ended
                const newLastDecayTimestamp = checkStartTime + (decayEvents * decayTimeMs);

                await savePetState({
                    hp: newHP,
                    lastDecayTimestamp: newLastDecayTimestamp, 
                });

                logMessage(`Health Decay Event: Lost ${totalLoss} HP over ${decayEvents} cycle(s). Endurance (${endStat}) reduced loss by ${Math.round(reductionPercent * 100)}%.`, 'warning');
                renderUI(); // Render immediately after decay
            }
        };


        /** Checks if the pet is ready for evolution based on stats. */
        const checkEvolution = async () => {
            if (petState.evolved) return;

            const AP_THRESHOLD = 5000;
            if (petState.ap < AP_THRESHOLD) return;

            const stats = petState.stats;
            const maxStatValue = Math.max(stats.str, stats.int, stats.end);
            
            // Check for ties or insufficient dominance
            const dominantStats = Object.keys(stats).filter(key => stats[key] === maxStatValue);
            if (dominantStats.length !== 1 || maxStatValue < 15) return; // Requires a clear winner and high enough stat

            let newSpecies = 'Adult';
            let newEmoji = 'üëæ';

            switch (dominantStats[0]) {
                case 'str':
                    newSpecies = 'Adult-Strength';
                    newEmoji = 'ü¶ç';
                    logMessage(`Evolution Success! Evolved into a fierce ${newSpecies}!`, 'success');
                    break;
                case 'int':
                    newSpecies = 'Adult-Intelligence';
                    newEmoji = 'ü¶â';
                    logMessage(`Evolution Success! Evolved into a cunning ${newSpecies}!`, 'success');
                    break;
                case 'end':
                    newSpecies = 'Adult-Endurance';
                    newEmoji = 'üê¢';
                    logMessage(`Evolution Success! Evolved into a resilient ${newSpecies}!`, 'success');
                    break;
            }

            // Increase Max HP on evolution
            const newMaxHP = petState.maxHp + 50;
            
            await savePetState({
                species: newSpecies,
                emoji: newEmoji,
                maxHp: newMaxHP,
                hp: newMaxHP, // Full heal on evolution
                evolved: true
            });
        };

        // --- Action Handlers (MUST be global for onclick in HTML) ---

        window.handleSyncActivity = async () => {
            if (petState.hp <= 0) return logMessage('Pet is deceased. Cannot perform actions.', 'error');

            const metrics = readMetricsFromInputs();

            const apGained = calculateAPFromMetrics(metrics);

            await savePetState({
                ap: petState.ap + apGained,
                lastActivityTimestamp: Date.now(),
                lastSyncBreakdown: { ...metrics, apGained }
            });

            // Reset inputs for the next session
            ['likes-input', 'comments-input', 'reposts-input', 'quotes-input', 'impressions-input'].forEach(id => {
                const input = document.getElementById(id);
                if (input) input.value = 0;
            });
            updateAPPreview();

            logMessage(`Synced X Activity! Gained ${apGained} AP from your latest X engagement.`, 'success');
            checkEvolution();
        };

        window.handleFeed = async () => {
            if (petState.hp <= 0) return logMessage('Pet is deceased. Cannot perform actions.', 'error');
            if (petState.ap < 100) return logMessage('Not enough AP to Feed (requires 100 AP).', 'warning');

            const hpRecovered = Math.round(petState.maxHp * 0.25); // Recover 25% of Max HP
            const newHP = petState.hp + hpRecovered;
            
            // Only Feed updates the decay pause timer
            const newDecayPauseUntil = Date.now() + (FEED_PAUSE_HOURS * 60 * 60 * 1000);

            await savePetState({
                ap: petState.ap - 100,
                hp: newHP,
                decayPauseUntil: newDecayPauseUntil,
                lastActivityTimestamp: Date.now()
            });

            logMessage(`Fed ${petState.name}! Recovered ${hpRecovered} HP. Decay paused until ${new Date(newDecayPauseUntil).toLocaleTimeString()}.`, 'success');
        };

        window.handleHeal = async () => {
            if (petState.hp <= 0) return logMessage('Pet is deceased. Cannot perform actions.', 'error');
            if (!petState.isInjured) return logMessage('Pet is not injured.', 'info');
            if (petState.ap < 200) return logMessage('Not enough AP to Heal (requires 200 AP).', 'warning');

            await savePetState({
                ap: petState.ap - 200,
                isInjured: false,
                lastActivityTimestamp: Date.now()
            });

            logMessage(`Healed ${petState.name}! Injury removed, decay rate is normal again.`, 'success');
        };

        window.handleTrain = async () => {
            if (petState.hp <= 0) return logMessage('Pet is deceased. Cannot perform actions.', 'error');
            if (petState.ap < 150) return logMessage('Not enough AP to Train (requires 150 AP).', 'warning');
            if (petState.isInjured) return logMessage('Cannot Train while Injured.', 'warning');

            await savePetState({ ap: petState.ap - 150 });

            // Training success logic: Int increases Critical Success, lowers Failure risk
            const intStat = petState.stats.int;
            const roll = Math.random() * 100;

            let resultMessage = '';
            let updates = {};

            if (roll < (5 + intStat * 2)) { // Critical Success chance (e.g., 5% + 2% per Int)
                const spGained = 3;
                updates.sp = petState.sp + spGained;
                resultMessage = `CRITICAL SUCCESS! Gained ${spGained} SP!`;
                logMessage(resultMessage, 'success');
            } else if (roll < (15 + intStat * 5)) { // Normal Success
                const spGained = 1;
                updates.sp = petState.sp + spGained;
                resultMessage = `Training Success. Gained ${spGained} SP.`;
                logMessage(resultMessage, 'info');
            } else { // Failure: -10 HP, -1 SP loss
                const newHP = petState.hp - 10;
                updates.hp = newHP;
                updates.sp = Math.max(0, petState.sp - 1);
                resultMessage = `Training Failure. Lost 10 HP and 1 SP!`;
                logMessage(resultMessage, 'warning');

                // Check for injury on failure (15% chance)
                if (Math.random() < INJURY_CHANCE) {
                    updates.isInjured = true;
                    logMessage(`${petState.name} suffered an INJURY during training!`, 'error');
                }
            }

            await savePetState({ ...updates, lastActivityTimestamp: Date.now() });
            checkEvolution();
        };

        window.handleBattle = async () => {
            if (petState.hp <= 0) return logMessage('Pet is deceased. Cannot perform actions.', 'error');
            if (petState.ap < 120) return logMessage('Not enough AP to Battle (requires 120 AP).', 'warning');
            if (petState.isInjured) return logMessage('Cannot Battle while Injured.', 'warning');

            await savePetState({ ap: petState.ap - 120 });

            // Dynamic Rival Scaling: Rival strength is 80% of Pet's dominant stat + minor random offset
            const petStr = petState.stats.str;
            const petTotalStats = petStr + petState.stats.int + petState.stats.end;
            const rivalStrength = Math.round(petTotalStats * 0.4 + Math.random() * 5);

            // Win chance based on Strength difference
            const winProbability = Math.min(0.9, Math.max(0.1, petStr / rivalStrength / 2));
            const didWin = Math.random() < winProbability;

            let resultMessage = '';
            let updates = {};

            if (didWin) {
                const apGain = 500;
                const spGain = 2;
                updates.ap = petState.ap + apGain;
                updates.sp = petState.sp + spGain;
                resultMessage = `BATTLE VICTORY! Strength (${petStr}) overcame Rival (${rivalStrength}). Gained ${apGain} AP and ${spGain} SP!`;
                logMessage(resultMessage, 'success');
            } else {
                const hpLoss = 30;
                updates.hp = petState.hp - hpLoss;
                resultMessage = `BATTLE DEFEAT. Lost 30 HP to the Rival (${rivalStrength}).`;
                logMessage(resultMessage, 'warning');

                // Check for injury on loss (15% chance)
                if (Math.random() < INJURY_CHANCE) {
                    updates.isInjured = true;
                    logMessage(`${petState.name} suffered an INJURY during the battle!`, 'error');
                }
            }

            await savePetState({ ...updates, lastActivityTimestamp: Date.now() });
            checkEvolution();
        };

        window.allocateSP = async (statKey) => {
            if (petState.sp < 1) return logMessage('No Stat Points (SP) available for allocation.', 'warning');

            const newStats = { ...petState.stats, [statKey]: petState.stats[statKey] + 1 };
            
            await savePetState({
                sp: petState.sp - 1,
                stats: newStats,
                lastActivityTimestamp: Date.now()
            });

            logMessage(`Allocated 1 SP to ${statKey.toUpperCase()}.`, 'info');
            checkEvolution();
        };

        window.connectXAccountAndHatch = async () => {
            const nameInput = document.getElementById('pet-name-input');
            let rawName = nameInput.value.trim();
            let newName = rawName;

            // 1. Basic Formatting: Ensure it starts with '@'
            if (!newName.startsWith('@')) {
                newName = '@' + newName;
            }

            const handleBase = newName.substring(1); // Get the part after '@'

            // 2. Comprehensive Validation:
            // X handles must be 1 to 15 characters long (after @)
            // They can only contain alphanumeric characters and underscores.
            const handleRegex = /^[a-zA-Z0-9_]{1,15}$/;

            if (handleBase.length === 0) {
                logMessage('X handle cannot be empty.', 'error');
                return;
            }
            if (handleBase.length > 15) {
                logMessage('X handle is too long (max 15 characters after @).', 'error');
                return;
            }
            if (!handleRegex.test(handleBase)) {
                 logMessage('X handle contains invalid characters. Use only letters, numbers, and underscores.', 'error');
                 return;
            }

            // --- Success Path ---
            
            // Save the validated and formatted name
            await savePetState({ name: newName });
            
            // Clear input field and hide modal
            nameInput.value = '';
            document.getElementById('modal-backdrop').classList.add('hidden');
            document.getElementById('modal-backdrop').classList.remove('flex');
            
            renderUI();
            
            logMessage(`X Account ${newName} connected. Pet hatched! Starting simulation!`, 'success');
        };

        // --- Firebase Initialization and Game Loop ---

        const hideLoading = () => {
            const loadingScreen = document.getElementById('loading');
            loadingScreen.classList.add('hidden');
        };

        const initializeGame = async () => {
            if (!firebaseConfig) {
                logMessage("Firebase config not found. Cannot proceed.", 'error');
                hideLoading();
                return;
            }

            // Fix: setLogLevel is imported from firebase-app.js
            setLogLevel('debug'); // Enable Firebase logging
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // 1. Authenticate User
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication failed: ", error);
                logMessage("Authentication failed. Check Firebase config.", 'error');
                hideLoading();
                return;
            }

            // 2. Wait for Auth State Change to get userId
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('user-id-display').textContent = `User ID: ${userId}`;
                    
                    // 3. Setup Real-time Listener (onSnapshot)
                    const petRef = getPetDocRef();
                    onSnapshot(petRef, async (docSnap) => {
                        hideLoading();
                        
                        // New User / First Load
                        if (!docSnap.exists() || docSnap.data().hp === 0) {
                            if (docSnap.data() && docSnap.data().hp === 0) {
                                logMessage('Your previous pet perished. Starting a new Egg.', 'info');
                            }
                            // Reset state for new game
                            petState = { ...INITIAL_PET_STATE };
                            await savePetState(); // Save initial state
                            document.getElementById('modal-backdrop').classList.add('flex');
                            document.getElementById('modal-backdrop').classList.remove('hidden');
                            renderUI();
                            return;
                        }

                        // Existing Data Loaded
                        // Ensure compatibility with older data missing 'decayPauseUntil'
                        const loadedData = docSnap.data();
                        if (typeof loadedData.decayPauseUntil === 'undefined') {
                             loadedData.decayPauseUntil = loadedData.lastActivityTimestamp || Date.now();
                        }
                        if (typeof loadedData.lastSyncBreakdown === 'undefined') {
                            loadedData.lastSyncBreakdown = { likes: 0, comments: 0, reposts: 0, quotes: 0, impressions: 0, apGained: 0 };
                        }
                        petState = loadedData;

                        // 4. Apply Decay & Update UI
                        await checkAndApplyDecay();
                        renderUI();
                        
                        // Check for evolution immediately after state update
                        checkEvolution();
                    }, (error) => {
                        console.error("Snapshot listener failed: ", error);
                        logMessage("Failed to listen for data updates.", 'error');
                        hideLoading();
                    });
                } else {
                    console.log("No user signed in.");
                }
            });
        };

        // Start the application
        window.onload = initializeGame;
    </script>
</body>
</html>